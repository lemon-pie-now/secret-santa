<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secret Santa Links</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>Secret Santa Links</h1>
    <p class="hint">
      Find your name and click your Secret Link.
      That page will show who you are gifting to and your recipientâ€™s wishlist (if they added one).
    </p>

    <p id="error" class="error"></p>
    <div id="results"></div>
  </div>

  <script>
    // MUST match your frontend app.js API_BASE
    const API_BASE = "https://secret-santa-api-ijd1.onrender.com/";

    const errorEl = document.getElementById("error");
    const resultsEl = document.getElementById("results");

    document.addEventListener("DOMContentLoaded", async () => {
      const eventId = getQueryParam("event");
      if (!eventId) {
        errorEl.textContent = "Missing event id. Ask the organizer for the correct link.";
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/event/${encodeURIComponent(eventId)}/pairs`);
        if (!res.ok) throw new Error("Failed to load event pairs");
        const data = await res.json();

        renderTable(eventId, data.pairs || []);
      } catch (err) {
        console.error(err);
        errorEl.textContent = "Could not load the event. Check the link or try again later.";
      }
    });

    function renderTable(eventId, pairs) {
      resultsEl.innerHTML = "";

      if (!pairs.length) {
        resultsEl.textContent = "No pairs found for this event.";
        return;
      }

      const table = document.createElement("table");

      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["Name", "Secret Link"].forEach((t) => {
        const th = document.createElement("th");
        th.textContent = t;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      const assignmentBase =
        window.location.origin +
        window.location.pathname.replace(/results\.html?$/i, "");

      // Sort by giver name for nicer UX
      pairs.sort((a, b) => (a.giver || "").localeCompare(b.giver || ""));

      for (const p of pairs) {
        const linkUrl =
          `${assignmentBase}?event=${encodeURIComponent(eventId)}&key=${encodeURIComponent(p.key)}`;

        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = p.giver;
        tr.appendChild(nameTd);

        const linkTd = document.createElement("td");
        const a = document.createElement("a");
        a.href = linkUrl;
        a.textContent = linkUrl;
        a.target = "_blank";
        linkTd.appendChild(a);
        tr.appendChild(linkTd);

        tbody.appendChild(tr);
      }

      table.appendChild(tbody);
      resultsEl.appendChild(table);
    }

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
  </script>
</body>
</html>