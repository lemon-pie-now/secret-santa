<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secret Santa Links</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>Secret Santa Links</h1>
    <p class="hint">
      Find your name in the list below and click your link to reveal who you are gifting to.
      <br>
      If a recipient has added their gift preferences, they will appear in the "Recipient Wishlist" column.
    </p>
    <p id="error" class="error"></p>
    <div id="results"></div>
  </div>

  <script>
    // ðŸ‘‡ Set this to your deployed backend URL (NOT localhost)
    // e.g. "https://secret-santa-api-xyz.onrender.com"
    const API_BASE = "https://your-api-name.onrender.com";

    const errorEl = document.getElementById("error");
    const resultsEl = document.getElementById("results");

    document.addEventListener("DOMContentLoaded", () => {
      const dataParam = getQueryParam("data");
      if (!dataParam) {
        errorEl.textContent = "No Secret Santa data found in the URL.";
        return;
      }

      let pairs;
      try {
        const json = decodeBase64(dataParam);
        pairs = JSON.parse(json);
      } catch (e) {
        console.error(e);
        errorEl.textContent = "Could not read Secret Santa data.";
        return;
      }

      if (!Array.isArray(pairs) || pairs.length === 0) {
        errorEl.textContent = "No assignments found.";
        return;
      }

      renderLinksTable(pairs);
    });

    // Render the table with wishlist info
    function renderLinksTable(pairs) {
      const table = document.createElement("table");

      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["Giver", "Recipient", "Secret Link", "Recipient Wishlist"].forEach((text) => {
        const th = document.createElement("th");
        th.textContent = text;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      // Link back to index.html in the same folder (default file)
      const assignmentBase =
        window.location.origin +
        window.location.pathname.replace(/results\.html?$/i, "");

      pairs.forEach((pair) => {
        const giverName = pair.from;
        const recipientName = pair.to;

        const linkUrl =
          `${assignmentBase}?giver=` +
          encodeURIComponent(giverName) +
          `&recipient=` +
          encodeURIComponent(recipientName);

        const tr = document.createElement("tr");

        // Giver
        const giverTd = document.createElement("td");
        giverTd.textContent = giverName;
        tr.appendChild(giverTd);

        // Recipient
        const recipientTd = document.createElement("td");
        recipientTd.textContent = recipientName;
        tr.appendChild(recipientTd);

        // Secret link
        const linkTd = document.createElement("td");
        const linkA = document.createElement("a");
        linkA.href = linkUrl;
        linkA.textContent = linkUrl;
        linkA.target = "_blank";
        linkTd.appendChild(linkA);
        tr.appendChild(linkTd);

        // Recipient wishlist (fetched from backend)
        const wishlistTd = document.createElement("td");
        wishlistTd.textContent = "Loading...";
        tr.appendChild(wishlistTd);

        // Fetch recipient's wishlist and update the cell
        loadWishlist(recipientName)
          .then((items) => {
            updateWishlistCell(wishlistTd, items);
          })
          .catch((err) => {
            console.error(err);
            wishlistTd.textContent = "Error loading wishlist";
          });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      resultsEl.appendChild(table);
    }

    // Update wishlist cell content
    function updateWishlistCell(cell, items) {
      cell.innerHTML = ""; // clear "Loading..."

      if (!items || items.length === 0) {
        const p = document.createElement("span");
        p.className = "hint";
        p.textContent = "No wishlist yet.";
        cell.appendChild(p);
        return;
      }

      const ul = document.createElement("ul");
      items.forEach((item) => {
        const li = document.createElement("li");
        li.textContent = item;
        ul.appendChild(li);
      });
      cell.appendChild(ul);
    }

    // ---- Wishlist: fetch from backend ----
    async function loadWishlist(name) {
      const url = `${API_BASE}/api/wishlist/${encodeURIComponent(name)}`;
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error("Failed to load wishlist");
      }
      const data = await res.json();
      return Array.isArray(data.items) ? data.items : [];
    }

    // Query param helper
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // Base64 helpers (must match encodeBase64 in app.js)
    function decodeBase64(str) {
      return decodeURIComponent(escape(atob(str)));
    }
  </script>
</body>
</html>