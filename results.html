<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secret Santa Links</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">

    <h1>Secret Santa Links</h1>
    <p class="hint">
      Participants: find your name and open your Secret Link.
      That page will show who you are gifting to and your recipientâ€™s wishlist (if they saved one).
    </p>

    <div class="card">
      <p class="hint">
        Event:
        <span id="eventLabel" class="mono"></span>
      </p>
      <div class="row">
        <input id="searchInput" class="search" type="text" placeholder="Search your name..." />
      </div>
    </div>

    <p id="error" class="error"></p>
    <div id="results" class="results"></div>

  </div>

  <script>
    // ðŸ”§ Set this to your deployed backend URL (Render/Railway/etc.)
    // Example: "https://secret-santa-api-xyz.onrender.com"
    const API_BASE = "https://YOUR-RENDER-API.onrender.com";

    const errorEl = document.getElementById("error");
    const resultsEl = document.getElementById("results");
    const eventLabelEl = document.getElementById("eventLabel");
    const searchInput = document.getElementById("searchInput");

    let eventId = null;
    let pairsCache = [];

    document.addEventListener("DOMContentLoaded", async () => {
      eventId = getQueryParam("event");
      if (!eventId) {
        errorEl.textContent = "Missing event id. Ask the organizer for the correct Results link.";
        return;
      }

      eventLabelEl.textContent = eventId;

      try {
        const res = await fetch(`${API_BASE}/api/event/${encodeURIComponent(eventId)}/pairs`);
        if (!res.ok) throw new Error("Failed to load event pairs");
        const data = await res.json();
        pairsCache = Array.isArray(data.pairs) ? data.pairs : [];

        renderTable(pairsCache);
      } catch (err) {
        console.error(err);
        errorEl.textContent = "Could not load this event. Check the link or try again later.";
      }
    });

    searchInput.addEventListener("input", () => {
      const q = (searchInput.value || "").trim().toLowerCase();
      const filtered = !q
        ? pairsCache
        : pairsCache.filter(p => (p.giver || "").toLowerCase().includes(q));
      renderTable(filtered);
    });

    function renderTable(pairs) {
      resultsEl.innerHTML = "";

      if (!pairs.length) {
        const p = document.createElement("p");
        p.className = "hint";
        p.textContent = "No matches.";
        resultsEl.appendChild(p);
        return;
      }

      // Base path to index.html in the same folder
      const assignmentBase =
        window.location.origin +
        window.location.pathname.replace(/results\.html?$/i, "");

      // Sort by giver
      const sorted = pairs.slice().sort((a, b) => (a.giver || "").localeCompare(b.giver || ""));

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      ["Name", "Secret Link"].forEach(t => {
        const th = document.createElement("th");
        th.textContent = t;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      for (const p of sorted) {
        const linkUrl =
          `${assignmentBase}?event=${encodeURIComponent(eventId)}&key=${encodeURIComponent(p.key)}`;

        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = p.giver || "";
        tr.appendChild(nameTd);

        const linkTd = document.createElement("td");
        const a = document.createElement("a");
        a.href = linkUrl;
        a.textContent = linkUrl;
        a.target = "_blank";
        linkTd.appendChild(a);
        tr.appendChild(linkTd);

        tbody.appendChild(tr);
      }

      table.appendChild(tbody);
      resultsEl.appendChild(table);
    }

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
  </script>
</body>
</html>